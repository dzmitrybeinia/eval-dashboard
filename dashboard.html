<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localization Quality Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .refresh-btn {
            grid-column: span 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            align-self: end;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .subtext {
            font-size: 0.85rem;
            color: #888;
        }

        .reports-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .section-header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .section-header-controls .control-group {
            flex: 1 1 200px;
        }

        .section-header {
            padding: 25px;
            background: #f8fafc;
            border-bottom: 1px solid #e1e8ed;
        }

        .section-header h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 5px;
        }

        .table-container {
            overflow-x: auto;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th {
            background: #f8fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e1e8ed;
            white-space: nowrap;
        }

        .reports-table td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }

        .reports-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reports-table tbody tr:hover {
            background: #f8fafc;
        }

        .language-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .language-english { background: #dbeafe; color: #1e40af; }
        .language-spanish { background: #fef3c7; color: #92400e; }
        .language-polish { background: #fce7f3; color: #be185d; }
        .language-russian { background: #ecfdf5; color: #059669; }
        .language-arabic { background: #fdf4ff; color: #86198f; }
        .language-serbian { background: #f3e8ff; color: #7c3aed; }
        .language-japanese { background: #ffedd5; color: #ea580c; }
        .language-french { background: #e0e7ff; color: #4338ca; }
        .language-german { background: #f1f5f9; color: #334155; }
        .language-portuguese { background: #fef2f2; color: #991b1b; }
        .language-hebrew { background: #cffafe; color: #0f766e; }

        .score-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .score-excellent { background: #dcfce7; color: #166534; }
        .score-good { background: #fef3c7; color: #92400e; }
        .score-acceptable { background: #fed7aa; color: #c2410c; }
        .score-poor { background: #fecaca; color: #dc2626; }


        .expandable-row {
            background: #f8fafc;
            display: none;
        }

        .expandable-row.active {
            display: table-row;
        }

        .detail-content {
            padding: 25px;
            border-left: 4px solid #667eea;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .detail-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .detail-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .score-breakdown {
            display: grid;
            gap: 10px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-bar {
            width: 60px;
            height: 6px;
            background: #e1e8ed;
            border-radius: 3px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 40%, #22c55e 80%);
            transition: width 0.3s ease;
        }

        .error-list {
            margin-top: 15px;
        }

        .error-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }

        .error-type {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .error-original {
            background: #fee2e2;
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9rem;
            font-family: monospace;
        }

        .error-correction {
            background: #dcfce7;
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .recommendations {
            margin-top: 20px;
        }

        .recommendation-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-reports {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .issues-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px 25px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .issues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 25px 30px;
        }

        .pattern-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pattern-header h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .pattern-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-linguistic {
            background: #fee2e2;
            color: #b91c1c;
        }

        .badge-localization {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-impact {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .badge-generic {
            background: #ede9fe;
            color: #5b21b6;
        }

        .pattern-description {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.5;
        }

        .pattern-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85rem;
            color: #555;
        }

        .pattern-footer span {
            background: #f8fafc;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .pattern-examples {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        .pattern-examples summary {
            cursor: pointer;
            font-weight: 600;
            color: #4361ee;
        }

        .example-card {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .example-context {
            font-style: italic;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .example-bad {
            background: #fee2e2;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .example-good {
            background: #dcfce7;
            padding: 8px;
            border-radius: 6px;
        }

        .issues-empty {
            padding: 40px;
            text-align: center;
            color: #666;
            font-size: 0.95rem;
        }

        .issues-grid.collapsed .pattern-card:not(:first-child) {
            display: none;
        }

        .expand-toggle-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .expand-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌍 Localization Quality Dashboard</h1>
            <p>Comprehensive analysis of localized content quality across all languages</p>
        </div>

        <!-- Label Descriptions Section -->
        <div class="reports-section" id="labelDescriptionsPanel" style="margin-bottom: 40px;">
            <div class="section-header">
                <h2>🏷️ Label Descriptions</h2>
            </div>
            <div class="section-content" id="labelDescriptionsContent" style="padding-top: 10px;">
                <div>Loading label descriptions...</div>
            </div>
        </div>

        <div class="reports-section" id="commonIssuesPanel" style="margin-bottom: 30px;">
            <div class="section-header">
                <h2>🧭 Common Issues &amp; Patterns</h2>
                <div class="section-header-controls">
                    <div class="control-group">
                        <label for="commonIssuesLanguage">Language</label>
                        <select id="commonIssuesLanguage">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="commonIssuesLabel">Label (Version)</label>
                        <select id="commonIssuesLabel">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="impactLevelFilter">Impact Level</label>
                        <select id="impactLevelFilter">
                            <option value="all">All Impact Levels</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="sortByFilter">Sort By</label>
                        <select id="sortByFilter">
                            <option value="impact_frequency">Impact & Frequency</option>
                            <option value="frequency_desc">Frequency (High to Low)</option>
                            <option value="frequency_asc">Frequency (Low to High)</option>
                            <option value="impact_desc">Impact (High to Low)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="commonIssuesContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading common issues...</div>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="reportLanguageFilter">Language</label>
                <select id="reportLanguageFilter">
                    <option value="all">All Languages</option>
                </select>
            </div>

            <div class="control-group">
                <label for="reportLabelFilter">Label (Version)</label>
                <select id="reportLabelFilter">
                    <option value="all">All Labels</option>
                </select>
            </div>
        </div>

        <div class="reports-section">
            <div class="section-header">
                <h2>📊 Detailed Reports</h2>
                <input type="text" id="searchBox" class="search-box" placeholder="Search reports by filename, language, or content...">
            </div>

            <div class="table-container">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>Language</th>
                            <th>File</th>
                            <th>Quality Score</th>
                            <th>Label</th>
                            <th>Timestamp</th>
                            <th>Errors</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- Reports will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allReports = [];
        let filteredReports = [];
        let allCommonIssues = null;
        let selectedCommonLabel = '';
        let selectedCommonLanguage = '';
        let selectedImpactLevel = 'all';
        let selectedSortBy = 'impact_frequency';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            refreshDashboard();
        });

        function refreshDashboard() {
            loadReports();
            loadLabelDescriptions();
            loadCommonIssues();
        }

        function setupEventListeners() {
            document.getElementById('reportLanguageFilter').addEventListener('change', filterReports);
            document.getElementById('reportLabelFilter').addEventListener('change', filterReports);
            document.getElementById('searchBox').addEventListener('input', filterReports);
        }

        async function loadReports() {
            showLoading();
            
            try {
                allReports = [];
                const languages = ['english', 'spanish', 'polish', 'french', 'russian', 'german', 'portuguese', 'japanese', 'serbian', 'arabic', 'hebrew'];
                
                for (const language of languages) {
                    try {
                        const reports = await loadLanguageReports(language);
                        allReports.push(...reports);
                    } catch (error) {
                        console.warn(`Failed to load reports for ${language}:`, error);
                    }
                }
                
                populateLanguageFilter();
                populateLabelFilter();
                updateStats();
                filterReports();
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showError('Failed to load reports. Please check console for details.');
            }
        }

        async function loadLabelDescriptions() {
            const content = document.getElementById('labelDescriptionsContent');
            if (!content) {
                return;
            }

            try {
                const response = await fetch('labels_descriptions.json');
                if (!response.ok) {
                    content.innerHTML = '<div class="issues-empty">📝 No label descriptions file found. Create labels_descriptions.json to add descriptions.</div>';
                    return;
                }

                const descriptions = await response.json();
                if (Object.keys(descriptions).length === 0) {
                    content.innerHTML = '<div class="issues-empty">📝 No labels described yet. Add entries to labels_descriptions.json.</div>';
                    return;
                }

                let html = '<ul style="list-style: none; padding: 0 0 0 20px; margin: 0;">';
                for (const [label, description] of Object.entries(descriptions)) {
                    html += `
                        <li style="padding: 12px 0; border-bottom: 1px solid #e1e8ed;">
                            <div style="display: flex; align-items: baseline; gap: 10px;">
                                <span style="font-weight: 600; color: #667eea; white-space: nowrap;">🏷️ ${label}</span>
                                <span style="color: #555;">— ${description}</span>
                            </div>
                        </li>
                    `;
                }
                html += '</ul>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Error loading label descriptions:', error);
                content.innerHTML = '<div class="issues-empty">⚠️ Unable to load label descriptions.</div>';
            }
        }

        async function loadCommonIssues() {
            const content = document.getElementById('commonIssuesContent');
            if (!content) {
                return;
            }

            content.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading common issues...</div>
                </div>
            `;

            try {
                const response = await fetch('issues/all/all_common_issues.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                allCommonIssues = await response.json();
                populateCommonIssueControls();
            } catch (error) {
                console.error('Error loading common issues:', error);
                content.innerHTML = '<div class="issues-empty">⚠️ Unable to load common issues. Ensure analyses have been generated.</div>';
            }
        }

        function populateCommonIssueControls() {
            const labelSelect = document.getElementById('commonIssuesLabel');
            const languageSelect = document.getElementById('commonIssuesLanguage');

            if (!labelSelect || !languageSelect || !allCommonIssues || !allCommonIssues.labels) {
                return;
            }

            const labelKeys = Object.keys(allCommonIssues.labels);
            if (labelKeys.length === 0) {
                labelSelect.innerHTML = '<option value="">No labels found</option>';
                languageSelect.innerHTML = '<option value="">–</option>';
                const content = document.getElementById('commonIssuesContent');
                if (content) {
                    content.innerHTML = '<div class="issues-empty">No common issue reports available yet.</div>';
                }
                return;
            }

            const latest = allCommonIssues.latest_label;
            if (!selectedCommonLabel || !allCommonIssues.labels[selectedCommonLabel]) {
                if (latest && allCommonIssues.labels[latest]) {
                    selectedCommonLabel = latest;
                } else {
                    selectedCommonLabel = labelKeys[labelKeys.length - 1];
                }
            }

            labelSelect.innerHTML = labelKeys
                .map(key => {
                    const labelData = allCommonIssues.labels[key];
                    const displayName = labelData && labelData.label ? labelData.label : key;
                    const selected = key === selectedCommonLabel ? ' selected' : '';
                    return `<option value="${key}"${selected}>${displayName}</option>`;
                })
                .join('');

            labelSelect.onchange = event => {
                selectedCommonLabel = event.target.value;
                populateCommonLanguageOptions();
            };

            populateCommonLanguageOptions();
        }

        function populateCommonLanguageOptions() {
            const languageSelect = document.getElementById('commonIssuesLanguage');
            const content = document.getElementById('commonIssuesContent');

            if (!languageSelect || !allCommonIssues || !allCommonIssues.labels) {
                return;
            }

            const labelData = allCommonIssues.labels[selectedCommonLabel];
            if (!labelData) {
                languageSelect.innerHTML = '<option value="">–</option>';
                if (content) {
                    content.innerHTML = '<div class="issues-empty">No data for the selected label.</div>';
                }
                return;
            }

            const languages = Array.isArray(labelData.languages) ? [...labelData.languages].sort() : [];

            // Default to "all" if not set or if current language is not available
            if (!selectedCommonLanguage || (selectedCommonLanguage !== 'all' && !languages.includes(selectedCommonLanguage))) {
                selectedCommonLanguage = 'all';
            }

            if (languages.length === 0) {
                languageSelect.innerHTML = '<option value="">No languages</option>';
                if (content) {
                    content.innerHTML = '<div class="issues-empty">No languages available for this label.</div>';
                }
                return;
            }

            const allOption = '<option value="all">All Languages</option>';
            const languageOptions = languages
                .map(language => {
                    const selected = language === selectedCommonLanguage ? ' selected' : '';
                    return `<option value="${language}"${selected}>${language}</option>`;
                })
                .join('');

            const allSelected = selectedCommonLanguage === 'all' ? ' selected' : '';
            languageSelect.innerHTML = `<option value="all"${allSelected}>All Languages</option>${languageOptions}`;

            languageSelect.onchange = event => {
                selectedCommonLanguage = event.target.value;
                renderCommonIssues();
            };

            // Setup impact level and sort by filters
            const impactLevelFilter = document.getElementById('impactLevelFilter');
            const sortByFilter = document.getElementById('sortByFilter');

            if (impactLevelFilter) {
                impactLevelFilter.value = selectedImpactLevel;
                impactLevelFilter.onchange = event => {
                    selectedImpactLevel = event.target.value;
                    renderCommonIssues();
                };
            }

            if (sortByFilter) {
                sortByFilter.value = selectedSortBy;
                sortByFilter.onchange = event => {
                    selectedSortBy = event.target.value;
                    renderCommonIssues();
                };
            }

            renderCommonIssues();
        }

        function renderCommonIssues() {
            const content = document.getElementById('commonIssuesContent');
            if (!content) {
                return;
            }

            if (!allCommonIssues || !allCommonIssues.labels) {
                content.innerHTML = '<div class="issues-empty">No common issue data available.</div>';
                return;
            }

            const labelData = allCommonIssues.labels[selectedCommonLabel];
            if (!labelData) {
                content.innerHTML = '<div class="issues-empty">No data found for the selected label.</div>';
                return;
            }

            if (!selectedCommonLanguage) {
                content.innerHTML = '<div class="issues-empty">Select a language to view recurring issues.</div>';
                return;
            }

            // Handle "all" languages case
            if (selectedCommonLanguage === 'all') {
                renderAllLanguagesIssues(labelData);
                return;
            }

            // Single language case
            const analysis = labelData.analyses ? labelData.analyses[selectedCommonLanguage] : null;
            let patterns = analysis && Array.isArray(analysis.top_error_patterns) ? analysis.top_error_patterns : [];

            // Apply impact level filter
            if (selectedImpactLevel !== 'all') {
                patterns = patterns.filter(p => p.impact_level === selectedImpactLevel);
            }

            // Apply sorting
            patterns = sortPatterns(patterns, selectedSortBy);

            if (!patterns.length) {
                content.innerHTML = `<div class="issues-empty">No recurring issues found for ${selectedCommonLanguage} (${labelData.label || selectedCommonLabel}).</div>`;
                return;
            }

            const generatedAt = labelData.generated_at ? formatTimestamp(labelData.generated_at) : '';
            const metaHtml = `
                <div class="issues-meta">
                    <span><strong>Label:</strong> ${labelData.label || selectedCommonLabel}</span>
                    <span><strong>Language:</strong> ${selectedCommonLanguage}</span>
                    ${generatedAt ? `<span><strong>Generated:</strong> ${generatedAt}</span>` : ''}
                    <span><strong>Patterns:</strong> ${patterns.length}</span>
                </div>
            `;

            const cardsHtml = patterns.map(pattern => renderPatternCard(pattern)).join('');
            const expandBtnHtml = patterns.length > 1 ? `
                <button class="expand-toggle-btn" onclick="toggleCommonIssues(this)">
                    Show All ${patterns.length} Issues
                </button>
            ` : '';
            content.innerHTML = metaHtml + `<div class="issues-grid collapsed" id="commonIssuesGrid">${cardsHtml}</div>${expandBtnHtml}`;
        }

        function renderAllLanguagesIssues(labelData) {
            const content = document.getElementById('commonIssuesContent');
            if (!labelData.analyses) {
                content.innerHTML = '<div class="issues-empty">No analyses available.</div>';
                return;
            }

            const languages = Array.isArray(labelData.languages) ? labelData.languages : [];
            let allPatterns = [];

            // Collect patterns from all languages
            languages.forEach(language => {
                const analysis = labelData.analyses[language];
                if (analysis && Array.isArray(analysis.top_error_patterns)) {
                    analysis.top_error_patterns.forEach(pattern => {
                        allPatterns.push({
                            ...pattern,
                            _language: language
                        });
                    });
                }
            });

            // Apply impact level filter
            if (selectedImpactLevel !== 'all') {
                allPatterns = allPatterns.filter(p => p.impact_level === selectedImpactLevel);
            }

            // Apply sorting
            allPatterns = sortPatterns(allPatterns, selectedSortBy);

            if (allPatterns.length === 0) {
                content.innerHTML = `<div class="issues-empty">No recurring issues found for any language (${labelData.label || selectedCommonLabel}).</div>`;
                return;
            }

            const generatedAt = labelData.generated_at ? formatTimestamp(labelData.generated_at) : '';
            const metaHtml = `
                <div class="issues-meta">
                    <span><strong>Label:</strong> ${labelData.label || selectedCommonLabel}</span>
                    <span><strong>Languages:</strong> All (${languages.length})</span>
                    ${generatedAt ? `<span><strong>Generated:</strong> ${generatedAt}</span>` : ''}
                    <span><strong>Patterns:</strong> ${allPatterns.length}</span>
                </div>
            `;

            const cardsHtml = allPatterns.map(pattern => renderPatternCardWithLanguage(pattern)).join('');
            const expandBtnHtml = allPatterns.length > 1 ? `
                <button class="expand-toggle-btn" onclick="toggleCommonIssues(this)">
                    Show All ${allPatterns.length} Issues
                </button>
            ` : '';
            content.innerHTML = metaHtml + `<div class="issues-grid collapsed" id="commonIssuesGrid">${cardsHtml}</div>${expandBtnHtml}`;
        }

        function sortPatterns(patterns, sortBy) {
            const severity_priority = {"HIGH": 3, "MEDIUM": 2, "LOW": 1};
            const patternsCopy = [...patterns];

            switch(sortBy) {
                case 'frequency_desc':
                    patternsCopy.sort((a, b) => (b.frequency_count || 0) - (a.frequency_count || 0));
                    break;
                case 'frequency_asc':
                    patternsCopy.sort((a, b) => (a.frequency_count || 0) - (b.frequency_count || 0));
                    break;
                case 'impact_desc':
                    patternsCopy.sort((a, b) => {
                        const impactA = severity_priority[a.impact_level] || 0;
                        const impactB = severity_priority[b.impact_level] || 0;
                        return impactB - impactA;
                    });
                    break;
                case 'impact_frequency':
                default:
                    patternsCopy.sort((a, b) => {
                        const impactA = severity_priority[a.impact_level] || 0;
                        const impactB = severity_priority[b.impact_level] || 0;
                        if (impactB !== impactA) {
                            return impactB - impactA;
                        }
                        return (b.frequency_count || 0) - (a.frequency_count || 0);
                    });
                    break;
            }

            return patternsCopy;
        }

        function renderPatternCardWithLanguage(pattern) {
            const categoryLabel = formatCategoryLabel(pattern.category);
            let categoryClass = 'badge-generic';
            if (pattern.category === 'localization') {
                categoryClass = 'badge-localization';
            } else if (pattern.category === 'linguistic') {
                categoryClass = 'badge-linguistic';
            }
            const impactLabel = formatImpactLabel(pattern.impact_level);
            const frequencyCount = normalizeFrequencyCount(pattern.frequency_count);
            const footerItems = [];

            if (pattern._language) {
                footerItems.push(`<span><strong>Language:</strong> ${pattern._language}</span>`);
            }
            if (pattern.subcategory) {
                footerItems.push(`<span>Subcategory: ${pattern.subcategory}</span>`);
            }
            if (frequencyCount !== null) {
                footerItems.push(`<span>Occurrences: ${frequencyCount}</span>`);
            }

            const examplesHtml = renderPatternExamples(pattern.examples);

            return `
                <div class="pattern-card">
                    <div class="pattern-header">
                        <h3>${pattern.pattern_name || 'Unnamed pattern'}</h3>
                        <div class="pattern-badges">
                            ${categoryLabel ? `<span class="badge ${categoryClass}">${categoryLabel}</span>` : ''}
                            ${impactLabel ? `<span class="badge badge-impact">${impactLabel}</span>` : ''}
                        </div>
                    </div>
                    <p class="pattern-description">${pattern.description || 'No description provided.'}</p>
                    ${footerItems.length ? `<div class="pattern-footer">${footerItems.join('')}</div>` : ''}
                    ${examplesHtml}
                </div>
            `;
        }

        function renderPatternCard(pattern) {
            const categoryLabel = formatCategoryLabel(pattern.category);
            let categoryClass = 'badge-generic';
            if (pattern.category === 'localization') {
                categoryClass = 'badge-localization';
            } else if (pattern.category === 'linguistic') {
                categoryClass = 'badge-linguistic';
            }
            const impactLabel = formatImpactLabel(pattern.impact_level);
            const frequencyCount = normalizeFrequencyCount(pattern.frequency_count);
            const footerItems = [];

            if (pattern.subcategory) {
                footerItems.push(`<span>Subcategory: ${pattern.subcategory}</span>`);
            }
            if (frequencyCount !== null) {
                footerItems.push(`<span>Occurrences: ${frequencyCount}</span>`);
            }

            const examplesHtml = renderPatternExamples(pattern.examples);

            return `
                <div class="pattern-card">
                    <div class="pattern-header">
                        <h3>${pattern.pattern_name || 'Unnamed pattern'}</h3>
                        <div class="pattern-badges">
                            ${categoryLabel ? `<span class="badge ${categoryClass}">${categoryLabel}</span>` : ''}
                            ${impactLabel ? `<span class="badge badge-impact">${impactLabel}</span>` : ''}
                        </div>
                    </div>
                    <p class="pattern-description">${pattern.description || 'No description provided.'}</p>
                    ${footerItems.length ? `<div class="pattern-footer">${footerItems.join('')}</div>` : ''}
                    ${examplesHtml}
                </div>
            `;
        }

        function renderPatternExamples(examples) {
            if (!Array.isArray(examples) || examples.length === 0) {
                return '';
            }

            const label = examples.length === 1 ? 'Show example' : `Show ${examples.length} examples`;
            return `
                <details class="pattern-examples">
                    <summary>${label}</summary>
                    ${examples.map(example => renderPatternExample(example)).join('')}
                </details>
            `;
        }

        function renderPatternExample(example) {
            if (!example || typeof example !== 'object') {
                return '';
            }

            const context = example.context ? `<div class="example-context">${example.context}</div>` : '';
            const wrong = example.wrong ? `<div class="example-bad"><strong>Issue:</strong> ${example.wrong}</div>` : '';
            const correct = example.correct ? `<div class="example-good"><strong>Improved:</strong> ${example.correct}</div>` : '';

            if (!context && !wrong && !correct) {
                return '';
            }

            return `<div class="example-card">${context}${wrong}${correct}</div>`;
        }

        function normalizeFrequencyCount(value) {
            if (value === undefined || value === null) {
                return null;
            }
            const numeric = Number(value);
            return Number.isFinite(numeric) ? numeric : null;
        }

        function formatCategoryLabel(value) {
            if (!value) {
                return '';
            }
            return value.charAt(0).toUpperCase() + value.slice(1);
        }

        function formatImpactLabel(value) {
            if (!value) {
                return '';
            }
            return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        }

        async function loadLanguageReports(language) {
            const reports = [];
            
            // Try to load evaluation files - we'll attempt common patterns
            const possibleFiles = await discoverEvaluationFiles(language);
            
            for (const filename of possibleFiles) {
                try {
                    const response = await fetch(`eval_results/${language}/${filename}`);
                    if (response.ok) {
                        const data = await response.json();
                        data._filename = filename;
                        data._language = language;
                        reports.push(data);
                    }
                } catch (error) {
                    console.warn(`Failed to load ${filename}:`, error);
                }
            }
            
            return reports;
        }

        async function discoverEvaluationFiles(language) {
            // Try to load dynamic file index first
            try {
                const response = await fetch('file_index.json');
                if (response.ok) {
                    const fileIndex = await response.json();
                    console.log('📋 Loaded file index:', fileIndex);
                    
                    if (fileIndex.files && fileIndex.files[language]) {
                        console.log(`📁 Found ${fileIndex.files[language].length} files for ${language}`);
                        return fileIndex.files[language];
                    }
                }
            } catch (error) {
                console.warn('⚠️ Could not load file_index.json, using fallback method:', error);
            }
            
            // Fallback to hardcoded files if file_index.json is not available
            console.log(`🔄 Using fallback file discovery for ${language}`);
            const knownFiles = {
                'english': ['evaluation_20250919_103527.json', 'evaluation_20250919_105122.json'],
                'spanish': ['evaluation_20250919_103906.json'],
                'polish': ['evaluation_20250919_103835.json'],
                'french': ['evaluation_20250919_123107.json'],
                'russian': ['evaluation_20250919_103940.json', 'evaluation_20250919_110412.json'],
                'german': [],
                'portuguese': [],
                'japanese': [],
                'serbian': ['evaluation_20250919_104018.json'],
                'arabic': [],
                'hebrew': []
            };
            
            return knownFiles[language] || [];
        }

        function populateLanguageFilter() {
            const languageFilter = document.getElementById('reportLanguageFilter');
            const languages = [...new Set(allReports.map(r => r.metadata.language))].sort();

            // Clear existing options except "All Languages"
            languageFilter.innerHTML = '<option value="all">All Languages</option>';

            languages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                languageFilter.appendChild(option);
            });
        }

        function populateLabelFilter() {
            const labelFilter = document.getElementById('reportLabelFilter');
            const labels = [...new Set(allReports.map(r => r.metadata.label).filter(label => label))].sort();

            // Clear existing options except "All Labels"
            labelFilter.innerHTML = '<option value="all">All Labels</option>';

            labels.forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                labelFilter.appendChild(option);
            });
        }

        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            if (allReports.length === 0) {
                statsGrid.innerHTML = '<div class="no-reports">No reports found. Click "Refresh Reports" to scan for evaluation files.</div>';
                return;
            }
            
            const totalReports = allReports.length;
            const avgScore = (allReports.reduce((sum, r) => sum + r.scores.overall_quality_score, 0) / totalReports).toFixed(1);
            const languages = [...new Set(allReports.map(r => r.metadata.language))];
            const classifications = allReports.reduce((acc, r) => {
                acc[r.scores.classification] = (acc[r.scores.classification] || 0) + 1;
                return acc;
            }, {});
            
            // Calculate total issues/errors for both new and old formats
            const totalIssues = allReports.reduce((sum, r) => {
                if (Array.isArray(r.issues)) {
                    // New simplified format: issues is an array
                    return sum + r.issues.length;
                } else if (r.issues && typeof r.issues === 'object') {
                    // Object format: count linguistic and localization issues only
                    const linguistic = r.issues.linguistic ? r.issues.linguistic.length : 0;
                    const localization = r.issues.localization ? r.issues.localization.length : 0;
                    return sum + linguistic + localization;
                } else if (r.errors) {
                    // Old format: count critical errors (most important)
                    return sum + (r.errors.critical ? r.errors.critical.length : 0);
                } else {
                    // Fallback: use scores.total_issues if available
                    return sum + (r.scores && r.scores.total_issues ? r.scores.total_issues : 0);
                }
            }, 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Reports</h3>
                    <div class="value">${totalReports}</div>
                    <div class="subtext">Across ${languages.length} languages</div>
                </div>
                <div class="stat-card">
                    <h3>Average Quality Score</h3>
                    <div class="value">${avgScore}/10</div>
                    <div class="subtext">${getScoreCategory(avgScore)} overall</div>
                </div>
                <div class="stat-card">
                    <h3>Total Issues</h3>
                    <div class="value">${totalIssues}</div>
                    <div class="subtext">Requiring attention</div>
                </div>
            `;
        }

        function updateFilteredStats() {
            const statsGrid = document.getElementById('statsGrid');
            const languageFilter = document.getElementById('reportLanguageFilter').value;
            const labelFilter = document.getElementById('reportLabelFilter').value;
            
            if (filteredReports.length === 0) {
                statsGrid.innerHTML = '<div class="no-reports">No reports match current filters. Adjust your selection to see statistics.</div>';
                return;
            }
            
            // Calculate statistics for filtered data
            const totalReports = filteredReports.length;
            const avgScore = (filteredReports.reduce((sum, r) => sum + r.scores.overall_quality_score, 0) / totalReports).toFixed(1);
            
            // Calculate average issues per report for filtered data
            const totalIssues = filteredReports.reduce((sum, r) => {
                if (Array.isArray(r.issues)) {
                    // New simplified format: issues is an array
                    return sum + r.issues.length;
                } else if (r.issues && typeof r.issues === 'object') {
                    // Object format: count linguistic and localization issues only
                    const linguistic = r.issues.linguistic ? r.issues.linguistic.length : 0;
                    const localization = r.issues.localization ? r.issues.localization.length : 0;
                    return sum + linguistic + localization;
                } else if (r.errors) {
                    return sum + (r.errors.critical ? r.errors.critical.length : 0);
                } else {
                    // Fallback: use scores.total_issues if available
                    return sum + (r.scores && r.scores.total_issues ? r.scores.total_issues : 0);
                }
            }, 0);
            
            const avgIssuesPerReport = (totalIssues / totalReports).toFixed(1);
            
            // Calculate issue breakdown for filtered data
            let issueBreakdown = { linguistic: 0, localization: 0 };
            filteredReports.forEach(r => {
                if (Array.isArray(r.issues)) {
                    // New simplified format: count by category
                    r.issues.forEach(issue => {
                        const category = issue.category || 'other';
                        if (category === 'linguistic') {
                            issueBreakdown.linguistic += 1;
                        } else if (category === 'localization') {
                            issueBreakdown.localization += 1;
                        }
                    });
                } else if (r.issues && typeof r.issues === 'object') {
                    // Object format: count linguistic and localization issues only
                    issueBreakdown.linguistic += r.issues.linguistic ? r.issues.linguistic.length : 0;
                    issueBreakdown.localization += r.issues.localization ? r.issues.localization.length : 0;
                }
            });
            
            const avgLinguistic = (issueBreakdown.linguistic / totalReports).toFixed(1);
            const avgLocalization = (issueBreakdown.localization / totalReports).toFixed(1);
            
            // Create contextual subtitle
            let contextSubtitle = '';
            if (languageFilter !== 'all' && labelFilter !== 'all') {
                contextSubtitle = `${languageFilter} | ${labelFilter}`;
            } else if (languageFilter !== 'all') {
                contextSubtitle = `${languageFilter} language`;
            } else if (labelFilter !== 'all') {
                contextSubtitle = `${labelFilter} version`;
            } else {
                contextSubtitle = 'All languages & versions';
            }
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Reports Analyzed</h3>
                    <div class="value">${totalReports}</div>
                    <div class="subtext">${contextSubtitle}</div>
                </div>
                <div class="stat-card">
                    <h3>Average Quality Score</h3>
                    <div class="value">${avgScore}/10</div>
                    <div class="subtext">${getScoreCategory(avgScore)} performance</div>
                </div>
                <div class="stat-card">
                    <h3>Average Issues Per Report</h3>
                    <div class="value">${avgIssuesPerReport}</div>
                    <div class="subtext">Total: ${totalIssues} issues</div>
                </div>
                <div class="stat-card">
                    <h3>Issue Breakdown (Avg)</h3>
                    <div class="value" style="font-size: 1.2rem; display: flex; gap: 10px; align-items: center;">
                        <span style="color: #dc2626;">🔤${avgLinguistic}</span>
                        <span style="color: #f59e0b;">🌍${avgLocalization}</span>
                    </div>
                    <div class="subtext">Linguistic | Localization</div>
                </div>
            `;
        }

        function filterReports() {
            const languageFilter = document.getElementById('reportLanguageFilter').value;
            const labelFilter = document.getElementById('reportLabelFilter').value;
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            filteredReports = allReports.filter(report => {
                const matchesLanguage = languageFilter === 'all' || report.metadata.language === languageFilter;
                const matchesLabel = labelFilter === 'all' || report.metadata.label === labelFilter;
                const matchesSearch = searchTerm === '' || 
                    report.metadata.file.toLowerCase().includes(searchTerm) ||
                    report.metadata.language.toLowerCase().includes(searchTerm) ||
                    JSON.stringify(report).toLowerCase().includes(searchTerm);
                
                return matchesLanguage && matchesLabel && matchesSearch;
            });
            
            // Update statistics whenever filters change
            updateFilteredStats();
            renderReportsTable();
        }

        function renderReportsTable() {
            const tbody = document.getElementById('reportsTableBody');
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-reports">
                            No reports match the current filters. Try adjusting your selection.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by quality score descending
            filteredReports.sort((a, b) => b.scores.overall_quality_score - a.scores.overall_quality_score);
            
            let html = '';
            filteredReports.forEach((report, index) => {
                // Handle both new and old format
                let issueCounts = { linguistic: 0, localization: 0 };
                let errorCounts = { critical: 0, major: 0, moderate: 0, minor: 0 };
                
                if (Array.isArray(report.issues)) {
                    // New simplified format: issues is an array
                    report.issues.forEach(issue => {
                        const category = issue.category || 'other';
                        if (category === 'linguistic') {
                            issueCounts.linguistic += 1;
                        } else if (category === 'localization') {
                            issueCounts.localization += 1;
                        }
                    });
                } else if (report.issues && typeof report.issues === 'object') {
                    // Object format: count linguistic and localization issues only
                    issueCounts.linguistic = report.issues.linguistic ? report.issues.linguistic.length : 0;
                    issueCounts.localization = report.issues.localization ? report.issues.localization.length : 0;
                } else if (report.errors) {
                    // Old format - for backward compatibility
                    errorCounts.critical = report.errors.critical ? report.errors.critical.length : 0;
                    errorCounts.major = report.errors.major ? report.errors.major.length : 0;
                    errorCounts.moderate = report.errors.moderate ? report.errors.moderate.length : 0;
                    errorCounts.minor = report.errors.minor ? report.errors.minor.length : 0;
                }
                
                const totalIssues = issueCounts.linguistic + issueCounts.localization;
                const totalErrors = errorCounts.critical + errorCounts.major + errorCounts.moderate + errorCounts.minor;
                
                html += `
                    <tr onclick="toggleDetails(${index})" data-index="${index}">
                        <td><span class="language-badge language-${report.metadata.language.toLowerCase()}">${report.metadata.language}</span></td>
                        <td>${report.metadata.file}</td>
                        <td><span class="score-badge ${getScoreClass(report.scores.overall_quality_score)}">${report.scores.overall_quality_score}/10</span></td>
                        <td>${report.metadata.label || ''}</td>
                        <td>${formatTimestamp(report.metadata.timestamp)}</td>
                        <td>
                            ${report.issues ? `
                                <div style="font-size: 0.8rem;">
                                    <span style="color: #dc2626;">🔤 ${issueCounts.linguistic}</span>
                                    <span style="color: #f59e0b;">🌍 ${issueCounts.localization}</span>
                                    <div style="margin-top: 2px; color: #6b7280; font-size: 0.7rem;">
                                        Total: ${totalIssues} issues
                                    </div>
                                </div>
                            ` : `
                                <div style="font-size: 0.8rem;">
                                    <span style="color: #dc2626;">🔴 ${errorCounts.critical}</span>
                                    <span style="color: #f59e0b;">🟡 ${errorCounts.major}</span>
                                    <span style="color: #3b82f6;">🔵 ${errorCounts.moderate}</span>
                                    <span style="color: #6b7280;">⚪ ${errorCounts.minor}</span>
                                </div>
                            `}
                        </td>
                    </tr>
                    <tr class="expandable-row" id="details-${index}">
                        <td colspan="6">
                            <div class="detail-content">
                                ${renderReportDetails(report)}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function renderReportDetails(report) {
            // Handle both new and old format
            if (report.issues) {
                // New format - display issues by category
                return renderNewFormatDetails(report);
            } else {
                // Old format - keep existing logic
                return renderOldFormatDetails(report);
            }
        }

        function renderNewFormatDetails(report) {
            // Handle both array format and object format for issues
            if (Array.isArray(report.issues)) {
                // New simplified format: issues is an array
                return renderSimplifiedFormatDetails(report);
            } else {
                // Legacy object format: issues has categories
                return renderCategorizedFormatDetails(report);
            }
        }
        
        function renderSimplifiedFormatDetails(report) {
            const issues = report.issues || [];
            
            // Group issues by category
            const issuesByCategory = issues.reduce((acc, issue) => {
                const category = issue.category || 'other';
                if (!acc[category]) acc[category] = [];
                acc[category].push(issue);
                return acc;
            }, {});
            
            return `
                <div class="detail-grid">
                    ${issuesByCategory.linguistic && issuesByCategory.linguistic.length > 0 ? `
                    <div class="detail-card">
                        <h4>🔤 Linguistic Issues (${issuesByCategory.linguistic.length})</h4>
                        <div class="error-list">
                            ${issuesByCategory.linguistic.map(issue => `
                                <div class="error-item" style="border-left-color: #dc2626;">
                                    <div class="error-type">${issue.subcategory || 'Linguistic Issue'} ${issue.severity ? `<span style="font-size: 0.8em; background: ${getSeverityColor(issue.severity)}; padding: 2px 6px; border-radius: 4px; color: white;">${issue.severity}</span>` : ''}</div>
                                    ${issue.original ? `<div class="error-original"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${issuesByCategory.localization && issuesByCategory.localization.length > 0 ? `
                    <div class="detail-card">
                        <h4>🌍 Localization Issues (${issuesByCategory.localization.length})</h4>
                        <div class="error-list">
                            ${issuesByCategory.localization.map(issue => `
                                <div class="error-item" style="border-left-color: #f59e0b; background: #fffbeb;">
                                    <div class="error-type" style="color: #d97706;">${issue.subcategory || 'Localization Issue'} ${issue.severity ? `<span style="font-size: 0.8em; background: ${getSeverityColor(issue.severity)}; padding: 2px 6px; border-radius: 4px; color: white;">${issue.severity}</span>` : ''}</div>
                                    ${issue.original ? `<div class="error-original" style="background: #fef3c7;"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${issuesByCategory.other && issuesByCategory.other.length > 0 ? `
                    <div class="detail-card">
                        <h4>📋 Other Issues (${issuesByCategory.other.length})</h4>
                        <div class="error-list">
                            ${issuesByCategory.other.map(issue => `
                                <div class="error-item" style="border-left-color: #6b7280; background: #f9fafb;">
                                    <div class="error-type" style="color: #4b5563;">${issue.subcategory || issue.category || 'Other Issue'} ${issue.severity ? `<span style="font-size: 0.8em; background: ${getSeverityColor(issue.severity)}; padding: 2px 6px; border-radius: 4px; color: white;">${issue.severity}</span>` : ''}</div>
                                    ${issue.original ? `<div class="error-original" style="background: #f3f4f6;"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${report.scores ? `
                    <div class="detail-card">
                        <h4>📊 Quality Breakdown</h4>
                        <div class="score-breakdown">
                            <div class="score-item">
                                <span>Overall Quality Score</span>
                                <span><strong>${report.scores.overall_quality_score}/10</strong></span>
                            </div>
                            <div class="score-item">
                                <span>Classification</span>
                                <span><strong>${report.scores.classification}</strong></span>
                            </div>
                            <div class="score-item">
                                <span>Total Issues Found</span>
                                <span><strong>${report.scores.total_issues || issues.length}</strong></span>
                            </div>
                            ${report.scores.issue_breakdown ? `
                                <div class="score-item">
                                    <span>Linguistic Issues</span>
                                    <span>${report.scores.issue_breakdown.linguistic}</span>
                                </div>
                                <div class="score-item">
                                    <span>Localization Issues</span>
                                    <span>${report.scores.issue_breakdown.localization}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderCategorizedFormatDetails(report) {
            const issues = report.issues || {};
            
            return `
                <div class="detail-grid">
                    ${issues.linguistic && issues.linguistic.length > 0 ? `
                    <div class="detail-card">
                        <h4>🔤 Linguistic Issues (${issues.linguistic.length})</h4>
                        <div class="error-list">
                            ${issues.linguistic.map(issue => `
                                <div class="error-item" style="border-left-color: #dc2626;">
                                    <div class="error-type">${issue.subcategory || 'Linguistic Issue'}</div>
                                    ${issue.original ? `<div class="error-original"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${issues.localization && issues.localization.length > 0 ? `
                    <div class="detail-card">
                        <h4>🌍 Localization Issues (${issues.localization.length})</h4>
                        <div class="error-list">
                            ${issues.localization.map(issue => `
                                <div class="error-item" style="border-left-color: #f59e0b; background: #fffbeb;">
                                    <div class="error-type" style="color: #d97706;">${issue.subcategory || 'Localization Issue'}</div>
                                    ${issue.original ? `<div class="error-original" style="background: #fef3c7;"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${issues.content_alignment && issues.content_alignment.length > 0 ? `
                    <div class="detail-card">
                        <h4>📚 Content Alignment Issues (${issues.content_alignment.length})</h4>
                        <div class="error-list">
                            ${issues.content_alignment.map(issue => `
                                <div class="error-item" style="border-left-color: #3b82f6; background: #eff6ff;">
                                    <div class="error-type" style="color: #2563eb;">${issue.subcategory || 'Content Issue'}</div>
                                    ${issue.original ? `<div class="error-original" style="background: #dbeafe;"><strong>Original:</strong> ${issue.original}</div>` : ''}
                                    ${issue.correction ? `<div class="error-correction"><strong>Correction:</strong> ${issue.correction}</div>` : ''}
                                    ${issue.description ? `<div><strong>Description:</strong> ${issue.description}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${report.scores ? `
                    <div class="detail-card">
                        <h4>📊 Quality Breakdown</h4>
                        <div class="score-breakdown">
                            <div class="score-item">
                                <span>Overall Quality Score</span>
                                <span><strong>${report.scores.overall_quality_score}/10</strong></span>
                            </div>
                            <div class="score-item">
                                <span>Classification</span>
                                <span><strong>${report.scores.classification}</strong></span>
                            </div>
                            <div class="score-item">
                                <span>Total Issues Found</span>
                                <span><strong>${report.scores.total_issues}</strong></span>
                            </div>
                            ${report.scores.issue_breakdown ? `
                                <div class="score-item">
                                    <span>Linguistic Issues</span>
                                    <span>${report.scores.issue_breakdown.linguistic}</span>
                                </div>
                                <div class="score-item">
                                    <span>Localization Issues</span>
                                    <span>${report.scores.issue_breakdown.localization}</span>
                                </div>
                                <div class="score-item">
                                    <span>Content Alignment Issues</span>
                                    <span>${report.scores.issue_breakdown.content_alignment}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function getSeverityColor(severity) {
            switch (severity?.toUpperCase()) {
                case 'HIGH': return '#dc2626';
                case 'MEDIUM': return '#f59e0b';
                case 'MINOR': return '#6b7280';
                default: return '#6b7280';
            }
        }

        function renderOldFormatDetails(report) {
            const detailedAnalysis = report.detailed_analysis || {};
            const errors = report.errors || {};
            const recommendations = report.recommendations || {};
            const patternAnalysis = report.pattern_analysis || {};
            
            return `
                <div class="detail-grid">
                    
                    ${errors.critical && errors.critical.length > 0 ? `
                    <div class="detail-card">
                        <h4>🚨 Critical Errors (${errors.critical.length})</h4>
                        <div class="error-list">
                            ${errors.critical.map(error => `
                                <div class="error-item" style="border-left-color: #dc2626;">
                                    <div class="error-type">${error.type}</div>
                                    ${error.original ? `<div class="error-original"><strong>Original:</strong> ${error.original}</div>` : ''}
                                    ${error.correction ? `<div class="error-correction"><strong>Correction:</strong> ${error.correction}</div>` : ''}
                                    ${error.impact ? `<div><strong>Impact:</strong> ${error.impact}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${errors.major && errors.major.length > 0 ? `
                    <div class="detail-card">
                        <h4>🟡 Major Errors (${errors.major.length})</h4>
                        <div class="error-list">
                            ${errors.major.map(error => `
                                <div class="error-item" style="border-left-color: #f59e0b; background: #fffbeb;">
                                    <div class="error-type" style="color: #d97706;">${error.type}</div>
                                    ${error.original ? `<div class="error-original" style="background: #fef3c7;"><strong>Original:</strong> ${error.original}</div>` : ''}
                                    ${error.correction ? `<div class="error-correction"><strong>Correction:</strong> ${error.correction}</div>` : ''}
                                    ${error.impact ? `<div><strong>Impact:</strong> ${error.impact}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${errors.moderate && errors.moderate.length > 0 ? `
                    <div class="detail-card">
                        <h4>🔵 Moderate Errors (${errors.moderate.length})</h4>
                        <div class="error-list">
                            ${errors.moderate.map(error => `
                                <div class="error-item" style="border-left-color: #3b82f6; background: #eff6ff;">
                                    <div class="error-type" style="color: #2563eb;">${error.type}</div>
                                    ${error.original ? `<div class="error-original" style="background: #dbeafe;"><strong>Original:</strong> ${error.original}</div>` : ''}
                                    ${error.correction ? `<div class="error-correction"><strong>Correction:</strong> ${error.correction}</div>` : ''}
                                    ${error.impact ? `<div><strong>Impact:</strong> ${error.impact}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${errors.minor && errors.minor.length > 0 ? `
                    <div class="detail-card">
                        <h4>⚪ Minor Errors (${errors.minor.length})</h4>
                        <div class="error-list">
                            ${errors.minor.map(error => `
                                <div class="error-item" style="border-left-color: #6b7280; background: #f9fafb;">
                                    <div class="error-type" style="color: #4b5563;">${error.type}</div>
                                    ${error.original ? `<div class="error-original" style="background: #f3f4f6;"><strong>Original:</strong> ${error.original}</div>` : ''}
                                    ${error.correction ? `<div class="error-correction"><strong>Correction:</strong> ${error.correction}</div>` : ''}
                                    ${error.impact ? `<div><strong>Impact:</strong> ${error.impact}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${recommendations.immediate_fixes && recommendations.immediate_fixes.length > 0 ? `
                    <div class="detail-card">
                        <h4>🔧 Immediate Fixes (${recommendations.immediate_fixes.length})</h4>
                        <div class="recommendations">
                            ${recommendations.immediate_fixes.map(fix => `
                                <div class="recommendation-item">${fix}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${recommendations.systematic_improvements && recommendations.systematic_improvements.length > 0 ? `
                    <div class="detail-card">
                        <h4>📈 Systematic Improvements (${recommendations.systematic_improvements.length})</h4>
                        <div class="recommendations">
                            ${recommendations.systematic_improvements.map(improvement => `
                                <div class="recommendation-item">${improvement}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${recommendations.prompt_optimizations && recommendations.prompt_optimizations.length > 0 ? `
                    <div class="detail-card">
                        <h4>🎯 Prompt Optimizations (${recommendations.prompt_optimizations.length})</h4>
                        <div class="recommendations">
                            ${recommendations.prompt_optimizations.map(optimization => `
                                <div class="recommendation-item" style="background: #f0f9ff; border-left-color: #0ea5e9;">${optimization}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${patternAnalysis.systematic_issues && patternAnalysis.systematic_issues.length > 0 ? `
                    <div class="detail-card">
                        <h4>🔍 Systematic Issues (${patternAnalysis.systematic_issues.length})</h4>
                        <div class="recommendations">
                            ${patternAnalysis.systematic_issues.map(issue => `
                                <div class="recommendation-item">
                                    <strong>${issue.pattern_name}:</strong> ${issue.description}
                                    ${issue.frequency ? `<br><small><strong>Frequency:</strong> ${issue.frequency}</small>` : ''}
                                    ${issue.examples && issue.examples.length > 0 ? `<br><small><strong>Examples:</strong> ${issue.examples.join(', ')}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${patternAnalysis.localization_gaps && patternAnalysis.localization_gaps.length > 0 ? `
                    <div class="detail-card">
                        <h4>📊 Localization Gaps (${patternAnalysis.localization_gaps.length})</h4>
                        <div class="recommendations">
                            ${patternAnalysis.localization_gaps.map(gap => `
                                <div class="recommendation-item">
                                    <strong>${gap.gap_type}:</strong> ${gap.description}
                                    ${gap.impact_assessment ? `<br><small><strong>Impact:</strong> ${gap.impact_assessment}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderScoreItem(label, value) {
            if (typeof value === 'number') {
                return `
                    <div class="score-item">
                        <span>${label}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${value}/10</span>
                            <div class="score-bar">
                                <div class="score-fill" style="width: ${(value/10)*100}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="score-item">
                        <span>${label}</span>
                        <span>${value}</span>
                    </div>
                `;
            }
        }

        function toggleDetails(index) {
            const detailsRow = document.getElementById(`details-${index}`);
            const isActive = detailsRow.classList.contains('active');
            
            // Close all other details
            document.querySelectorAll('.expandable-row.active').forEach(row => {
                row.classList.remove('active');
            });
            
            // Toggle current details
            if (!isActive) {
                detailsRow.classList.add('active');
            }
        }

        function getScoreClass(score) {
            if (score >= 9) return 'score-excellent';
            if (score >= 7) return 'score-good';
            if (score >= 5) return 'score-acceptable';
            return 'score-poor';
        }

        function getScoreCategory(score) {
            if (score >= 9) return 'Excellent';
            if (score >= 7) return 'Good';
            if (score >= 5) return 'Acceptable';
            return 'Needs Improvement';
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return timestamp;
            }
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showLoading() {
            document.getElementById('reportsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading evaluation reports...</div>
                    </td>
                </tr>
            `;
            document.getElementById('statsGrid').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Calculating statistics...</div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('reportsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="no-reports">
                        ❌ ${message}
                    </td>
                </tr>
            `;
        }

        function toggleCommonIssues(btn) {
            const grid = document.getElementById('commonIssuesGrid');
            if (grid.classList.contains('collapsed')) {
                grid.classList.remove('collapsed');
                btn.textContent = 'Show Less';
            } else {
                grid.classList.add('collapsed');
                const totalPatterns = grid.querySelectorAll('.pattern-card').length;
                btn.textContent = `Show All ${totalPatterns} Issues`;
            }
        }
    </script>
</body>
</html>
